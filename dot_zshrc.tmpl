# =============================================================================
# Zsh Configuration (managed by chezmoi)
# =============================================================================

# -----------------------------------------------------------------------------
# Homebrew (Apple Silicon / Intel Mac í˜¸í™˜)
# -----------------------------------------------------------------------------
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi


# -----------------------------------------------------------------------------
# SSH Agent ì„¤ì •ì„ ì „ì—­ì ìœ¼ë¡œ ìœ ì§€ (ëª¨ë“  ì‰˜ì´ ê³µìœ )
# -----------------------------------------------------------------------------
export SSH_AUTH_SOCK="$HOME/.ssh/ssh-agent.sock"

# ì—ì´ì „íŠ¸ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (ì—°ê²° ë¶ˆê°€ ì‹œ 2 ë°˜í™˜)
ssh-add -l > /dev/null 2>&1
if [ $? -eq 2 ]; then
    # ê¸°ì¡´ ì†Œì¼“ íŒŒì¼ ì •ë¦¬
    rm -f "$SSH_AUTH_SOCK"
    # ìƒˆ ì—ì´ì „íŠ¸ ì‹œì‘ (ì†Œì¼“ ê²½ë¡œ ê³ ì •)
    (umask 066; ssh-agent -a "$SSH_AUTH_SOCK" >/dev/null)
fi

# -----------------------------------------------------------------------------
# GPG ì„¤ì • (í„°ë¯¸ë„ì—ì„œ pinentry ì‚¬ìš©)
# -----------------------------------------------------------------------------
export GPG_TTY=$(tty)
gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

# -----------------------------------------------------------------------------
# NVM ì„¤ì • (Lazy Loading - ì‰˜ ì‹œì‘ ì†ë„ ê°œì„ )
# -----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"

# NVM lazy loading: nvm, node, npm ë“± ì²« í˜¸ì¶œ ì‹œì—ë§Œ ë¡œë“œ
_nvm_lazy_load() {
  unset -f nvm node npm npx pnpm yarn 2>/dev/null
  if [[ -f /opt/homebrew/opt/nvm/nvm.sh ]]; then
    source "/opt/homebrew/opt/nvm/nvm.sh"
    [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && source "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
  elif [[ -f /usr/local/opt/nvm/nvm.sh ]]; then
    source "/usr/local/opt/nvm/nvm.sh"
  fi
}

nvm() { _nvm_lazy_load; nvm "$@"; }
node() { _nvm_lazy_load; node "$@"; }
npm() { _nvm_lazy_load; npm "$@"; }
npx() { _nvm_lazy_load; npx "$@"; }
pnpm() { _nvm_lazy_load; pnpm "$@"; }
yarn() { _nvm_lazy_load; yarn "$@"; }

# -----------------------------------------------------------------------------
# PATH ì„¤ì •
# -----------------------------------------------------------------------------
export PATH="$HOME/.opencode/bin:$PATH"
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# -----------------------------------------------------------------------------
# ëª¨ë˜ CLI ë„êµ¬ ì´ˆê¸°í™”
# -----------------------------------------------------------------------------
# Starship í”„ë¡¬í”„íŠ¸
eval "$(starship init zsh)"

# Zoxide (ìŠ¤ë§ˆíŠ¸ cd)
eval "$(zoxide init zsh)"

# FZF
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# -----------------------------------------------------------------------------
# Aliases: ê¸°ì¡´ ë„êµ¬ -> ëª¨ë˜ ë„êµ¬ ëŒ€ì²´
# -----------------------------------------------------------------------------
# âœ… 100% í•˜ìœ„í˜¸í™˜ - aliasë¡œ ì™„ì „ ëŒ€ì²´ ê°€ëŠ¥
alias ls="eza"                    # ls -> eza
alias ll="eza -la"
alias la="eza -la"
alias lt="eza --tree"
alias cat="bat"                   # cat -> bat
alias find="fd"                   # find -> fd
alias grep="rg"                   # grep -> ripgrep
alias man="tldr"                  # man -> tldr (ê°„ë‹¨í•œ ì˜ˆì‹œìš©)

# ê¸°ì¡´ ë„êµ¬ ì ‘ê·¼ í•„ìš”ì‹œ
alias orig-ls="/bin/ls"
alias orig-cat="/bin/cat"
alias orig-find="/usr/bin/find"
alias orig-grep="/usr/bin/grep"
alias orig-man="/usr/bin/man"

# Git ê´€ë ¨
alias vim="nvim"
alias gs="git status -sb"
alias gp="git pull"
alias lg="lazygit"

# -----------------------------------------------------------------------------
# ëŒ€ì²´ ë„êµ¬ ì‚¬ìš© ê°€ì´ë“œ (100% í˜¸í™˜ ì•„ë‹Œ ê²½ìš°)
# -----------------------------------------------------------------------------
# | AS-IS (ê¸°ì¡´)              | TO-BE (ëª¨ë˜)                  | ë¹„ê³                     |
# |---------------------------|-------------------------------|-------------------------|
# | curl -X GET url           | http GET url                  | httpie: ë” ì§ê´€ì  ë¬¸ë²•  |
# | curl -d '{"a":1}' url     | http POST url a=1             | JSON ìë™ ì²˜ë¦¬          |
# | man command               | tldr command                  | ì „ì²´ ë§¤ë‰´ì–¼ì€ orig-man  |
# | cd /long/path && cd -     | z path (í•™ìŠµ í›„ ìë™ ì í”„)    | zoxide: íˆìŠ¤í† ë¦¬ ê¸°ë°˜   |

{{- if .isPersonal }}
# -----------------------------------------------------------------------------
# ì‹œí¬ë¦¿ ë° í‚¤ ê´€ë¦¬ (auth-start / auth-stop) - Personal ì „ìš©
# -----------------------------------------------------------------------------
SECRETS_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/secrets.env"
SECRETS_TTL=28800  # 8ì‹œê°„ (ì´ˆ)

auth-start() {
  # Infisical CLI ì„¤ì¹˜ í™•ì¸
  if ! command -v infisical &>/dev/null; then
    echo "âŒ Infisical CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    return 1
  fi

  # Zsh í•¨ìˆ˜ ì¢…ë£Œ ì‹œ trap ì‹¤í–‰ì„ ìœ„í•´ í•„ìš”í•œ ì˜µì…˜
  setopt LOCAL_TRAPS
  
  echo "ğŸ” Infisicalì—ì„œ ì¸ì¦ ì •ë³´ ë¡œë”©..."
  
  # ì„ì‹œ íŒŒì¼ ë³€ìˆ˜ ì„ ì–¸ (trapì—ì„œ ì‚¬ìš©)
  local ssh_key_tmp="" gpg_key_tmp=""
  trap 'rm -f "$ssh_key_tmp" "$gpg_key_tmp" 2>/dev/null' EXIT
  
  # 1. Infisical ë¡œê·¸ì¸ í™•ì¸
  if ! infisical whoami &>/dev/null; then
    infisical login
  fi
  
  # 2. ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± (XDG ê·œê²©)
  mkdir -p "$(dirname "$SECRETS_CACHE")"
  
  # 3. í™˜ê²½ë³€ìˆ˜ ì‹œí¬ë¦¿ ë¡œë“œ
  infisical export --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --format=dotenv > "$SECRETS_CACHE"
  chmod 600 "$SECRETS_CACHE"
  source "$SECRETS_CACHE"
  
  # 4. SSH í‚¤ ë¡œë“œ (Infisicalì— SSH_PRIVATE_KEYê°€ ìˆëŠ” ê²½ìš°)
  if infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "ğŸ”‘ SSH í‚¤ ë¡œë”© ì¤‘..."
    
    ssh_key_tmp=$(mktemp)
    infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain > "$ssh_key_tmp"
    chmod 600 "$ssh_key_tmp"
    
    # ssh-agentì— ì¶”ê°€ í›„ ì¦‰ì‹œ ì‚­ì œ (TTL ì ìš©: 8ì‹œê°„)
    ssh-add -t $SECRETS_TTL "$ssh_key_tmp" 2>/dev/null
    rm -f "$ssh_key_tmp"
    ssh_key_tmp=""
    
    echo "âœ… SSH í‚¤ê°€ ssh-agentì— ë¡œë“œë¨"
  fi
  
  # 5. GPG ê°œì¸í‚¤ ë¡œë“œ (Infisicalì— GPG_PRIVATE_KEYê°€ ìˆëŠ” ê²½ìš°)
  if infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "ğŸ” GPG í‚¤ ë¡œë”© ì¤‘..."
    
    gpg_key_tmp=$(mktemp)
    infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain > "$gpg_key_tmp"
    chmod 600 "$gpg_key_tmp"
    
    # GPG keyringì— import (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
    if ! gpg --batch --import "$gpg_key_tmp" 2>/dev/null; then
      echo "âš ï¸  GPG í‚¤ import ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ í˜•ì‹ ì˜¤ë¥˜)"
    fi
    rm -f "$gpg_key_tmp"
    gpg_key_tmp=""
    
    echo "âœ… GPG í‚¤ê°€ keyringì— ë¡œë“œë¨"
  fi
  
  # 6. GPG ì„œëª…í‚¤ ì„¤ì • (ë™ì  íŒŒì¼ ì‚¬ìš©)
  if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
    touch "$HOME/.gitconfig_env"
    git config -f "$HOME/.gitconfig_env" user.signingkey "$GIT_SIGNING_KEY"
    git config -f "$HOME/.gitconfig_env" commit.gpgsign true
    echo "âœ… GPG ì„œëª…í‚¤ ì„¤ì •ë¨: $GIT_SIGNING_KEY"

    # 7. GPG ì—ì´ì „íŠ¸ ì„¤ì • ë¦¬ë¡œë“œ ë° ìºì‹œ ì›œì—… (ë¹„ë°€ë²ˆí˜¸ ì¦‰ì‹œ ì…ë ¥ ìœ ë„)
    # ì„¤ì •ì„ í™•ì‹¤íˆ ì ìš©í•˜ê¸° ìœ„í•´ ì—ì´ì „íŠ¸ ë¦¬ë¡œë“œ
    gpg-connect-agent reloadagent /bye >/dev/null 2>&1
    
    echo "ğŸ” GPG ë¹„ë°€ë²ˆí˜¸ ìºì‹±ì„ ìœ„í•´ ì„œëª…ì„ ì‹œë„í•©ë‹ˆë‹¤ (8ì‹œê°„ ìœ ì§€)..."
    # ë”ë¯¸ ë°ì´í„° ì„œëª…ì„ í†µí•´ ë¹„ë°€ë²ˆí˜¸ í”„ë¡¬í”„íŠ¸ ê°•ì œ í˜¸ì¶œ
    echo "gpg-auth-start" | gpg --clearsign --local-user "$GIT_SIGNING_KEY" > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "âœ… GPG ë¹„ë°€ë²ˆí˜¸ê°€ ìºì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
    else
        echo "âš ï¸  GPG ì„œëª… ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì„ ì·¨ì†Œí–ˆê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ)"
    fi
  fi
  
  echo "âœ… ì¸ì¦ ì™„ë£Œ (8ì‹œê°„ ìœ íš¨)"
}

auth-stop() {
  echo "ğŸ”’ ì¸ì¦ ì •ë³´ ì •ë¦¬ ì¤‘..."
  
  # 1. ì‹œí¬ë¦¿ ìºì‹œ ì‚­ì œ
  if [[ -f "$SECRETS_CACHE" ]]; then
    rm -f "$SECRETS_CACHE"
  fi
  
  # 2. ssh-agentì—ì„œ ëª¨ë“  í‚¤ ì œê±°
  ssh-add -D 2>/dev/null || true
  
  # 3. ì„ì‹œ í‚¤ íŒŒì¼ ì‚­ì œ (mktemp ì‚¬ìš©ìœ¼ë¡œ ëŒ€ë¶€ë¶„ ìë™ ì •ë¦¬ë¨)
  # Legacy cleanup for any remaining files
  rm -f /tmp/.ssh_key_* /tmp/.gpg_key_* 2>/dev/null || true
  
  # 4. GPG ê°œì¸í‚¤ ì‚­ì œ (keyringì—ì„œ ì œê±°)
  if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
    # --batch --yesë¡œ í™•ì¸ ì—†ì´ ì‚­ì œ
    gpg --batch --yes --delete-secret-keys "$GIT_SIGNING_KEY" 2>/dev/null || true
    echo "âœ… GPG ê°œì¸í‚¤ ì‚­ì œë¨"
  fi
  
  # 5. Git ì„œëª… ì„¤ì • í•´ì œ (ë™ì  íŒŒì¼ ì •ë¦¬)
  if [[ -f "$HOME/.gitconfig_env" ]]; then
    git config -f "$HOME/.gitconfig_env" --unset user.signingkey 2>/dev/null || true
    git config -f "$HOME/.gitconfig_env" --unset commit.gpgsign 2>/dev/null || true
    # íŒŒì¼ì´ ë¹„ì—ˆìœ¼ë©´ ì‚­ì œí•˜ëŠ” ê²ƒë„ ì¢‹ìœ¼ë‚˜ ìœ ì§€í•´ë„ ë¬´ë°©
  fi
  
  # 6. í™˜ê²½ë³€ìˆ˜ unset
  unset GITHUB_TOKEN GIT_SIGNING_KEY SSH_PRIVATE_KEY GPG_PRIVATE_KEY 2>/dev/null || true
  
  echo "âœ… ëª¨ë“  ì¸ì¦ ì •ë³´ ì‚­ì œë¨"
}

# ì‰˜ ì‹œì‘ì‹œ ìºì‹œ ìœ íš¨ì„± ì²´í¬
if [[ -f "$SECRETS_CACHE" ]]; then
  cache_age=$(( $(date +%s) - $(stat -f %m "$SECRETS_CACHE") ))
  if (( cache_age < SECRETS_TTL )); then
    source "$SECRETS_CACHE"
  else
    rm -f "$SECRETS_CACHE"
    echo "â° ì‹œí¬ë¦¿ ìºì‹œ ë§Œë£Œ (8ì‹œê°„ ê²½ê³¼) - auth-startë¡œ ì¬ì¸ì¦ í•„ìš”"
  fi
fi
{{- end }}

