# =============================================================================
# Zsh Configuration (managed by chezmoi)
# =============================================================================

# -----------------------------------------------------------------------------
# Homebrew (Apple Silicon)
# -----------------------------------------------------------------------------
eval "$(/opt/homebrew/bin/brew shellenv)"

# -----------------------------------------------------------------------------
# GPG ì„¤ì • (í„°ë¯¸ë„ì—ì„œ pinentry ì‚¬ìš©)
# -----------------------------------------------------------------------------
export GPG_TTY=$(tty)

# -----------------------------------------------------------------------------
# NVM ì„¤ì •
# -----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"

# -----------------------------------------------------------------------------
# PATH ì„¤ì •
# -----------------------------------------------------------------------------
export PATH="$HOME/.opencode/bin:$PATH"
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# -----------------------------------------------------------------------------
# ëª¨ë˜ CLI ë„êµ¬ ì´ˆê¸°í™”
# -----------------------------------------------------------------------------
# Starship í”„ë¡¬í”„íŠ¸
eval "$(starship init zsh)"

# Zoxide (ìŠ¤ë§ˆíŠ¸ cd)
eval "$(zoxide init zsh)"

# FZF
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# -----------------------------------------------------------------------------
# Aliases: ê¸°ì¡´ ë„êµ¬ -> ëª¨ë˜ ë„êµ¬ ëŒ€ì²´
# -----------------------------------------------------------------------------
# âœ… 100% í•˜ìœ„í˜¸í™˜ - aliasë¡œ ì™„ì „ ëŒ€ì²´ ê°€ëŠ¥
alias ls="eza"                    # ls -> eza
alias ll="eza -la"
alias la="eza -la"
alias lt="eza --tree"
alias cat="bat"                   # cat -> bat
alias find="fd"                   # find -> fd
alias grep="rg"                   # grep -> ripgrep
alias man="tldr"                  # man -> tldr (ê°„ë‹¨í•œ ì˜ˆì‹œìš©)

# ê¸°ì¡´ ë„êµ¬ ì ‘ê·¼ í•„ìš”ì‹œ
alias orig-ls="/bin/ls"
alias orig-cat="/bin/cat"
alias orig-find="/usr/bin/find"
alias orig-grep="/usr/bin/grep"
alias orig-man="/usr/bin/man"

# Git ê´€ë ¨
alias vim="nvim"
alias gs="git status -sb"
alias gp="git pull"
alias lg="lazygit"

# -----------------------------------------------------------------------------
# ëŒ€ì²´ ë„êµ¬ ì‚¬ìš© ê°€ì´ë“œ (100% í˜¸í™˜ ì•„ë‹Œ ê²½ìš°)
# -----------------------------------------------------------------------------
# | AS-IS (ê¸°ì¡´)              | TO-BE (ëª¨ë˜)                  | ë¹„ê³                     |
# |---------------------------|-------------------------------|-------------------------|
# | curl -X GET url           | http GET url                  | httpie: ë” ì§ê´€ì  ë¬¸ë²•  |
# | curl -d '{"a":1}' url     | http POST url a=1             | JSON ìë™ ì²˜ë¦¬          |
# | man command               | tldr command                  | ì „ì²´ ë§¤ë‰´ì–¼ì€ orig-man  |
# | cd /long/path && cd -     | z path (í•™ìŠµ í›„ ìë™ ì í”„)    | zoxide: íˆìŠ¤í† ë¦¬ ê¸°ë°˜   |

# -----------------------------------------------------------------------------
# ì‹œí¬ë¦¿ ë° í‚¤ ê´€ë¦¬ (auth-start / auth-stop)
# -----------------------------------------------------------------------------
SECRETS_CACHE="$HOME/.secrets.env"
SECRETS_TTL=28800  # 8ì‹œê°„ (ì´ˆ)
SSH_KEY_CACHE="/tmp/.ssh_key_$$"
GPG_KEY_CACHE="/tmp/.gpg_key_$$"

auth-start() {
  echo "ğŸ” Infisicalì—ì„œ ì¸ì¦ ì •ë³´ ë¡œë”©..."
  
  # 1. Infisical ë¡œê·¸ì¸ í™•ì¸
  if ! infisical whoami &>/dev/null; then
    infisical login
  fi
  
  # 2. í™˜ê²½ë³€ìˆ˜ ì‹œí¬ë¦¿ ë¡œë“œ
  infisical export --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --format=dotenv > "$SECRETS_CACHE"
  chmod 600 "$SECRETS_CACHE"
  source "$SECRETS_CACHE"
  
  # 3. SSH í‚¤ ë¡œë“œ (Infisicalì— SSH_PRIVATE_KEYê°€ ìˆëŠ” ê²½ìš°)
  if infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "ğŸ”‘ SSH í‚¤ ë¡œë”© ì¤‘..."
    eval "$(ssh-agent -s)" > /dev/null
    
    # ì„ì‹œ íŒŒì¼ì— í‚¤ ì €ì¥
    infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain > "$SSH_KEY_CACHE"
    chmod 600 "$SSH_KEY_CACHE"
    
    # ssh-agentì— ì¶”ê°€ í›„ ì¦‰ì‹œ ì‚­ì œ
    ssh-add "$SSH_KEY_CACHE" 2>/dev/null
    rm -f "$SSH_KEY_CACHE"
    
    echo "âœ… SSH í‚¤ê°€ ssh-agentì— ë¡œë“œë¨"
  fi
  
  # 4. GPG ê°œì¸í‚¤ ë¡œë“œ (Infisicalì— GPG_PRIVATE_KEYê°€ ìˆëŠ” ê²½ìš°)
  if infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "ğŸ” GPG í‚¤ ë¡œë”© ì¤‘..."
    
    # ì„ì‹œ íŒŒì¼ì— í‚¤ ì €ì¥
    infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain > "$GPG_KEY_CACHE"
    chmod 600 "$GPG_KEY_CACHE"
    
    # GPG keyringì— import (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
    gpg --batch --import "$GPG_KEY_CACHE" 2>/dev/null || true
    rm -f "$GPG_KEY_CACHE"
    
    echo "âœ… GPG í‚¤ê°€ keyringì— ë¡œë“œë¨"
  fi
  
  # 5. GPG ì„œëª…í‚¤ ì„¤ì •
  if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
    git config --global user.signingkey "$GIT_SIGNING_KEY"
    git config --global commit.gpgsign true
    echo "âœ… GPG ì„œëª…í‚¤ ì„¤ì •ë¨: $GIT_SIGNING_KEY"
  fi
  
  echo "âœ… ì¸ì¦ ì™„ë£Œ (8ì‹œê°„ ìœ íš¨)"
}

auth-stop() {
  echo "ğŸ”’ ì¸ì¦ ì •ë³´ ì •ë¦¬ ì¤‘..."
  
  # 1. ì‹œí¬ë¦¿ ìºì‹œ ì‚­ì œ
  if [[ -f "$SECRETS_CACHE" ]]; then
    rm -f "$SECRETS_CACHE"
  fi
  
  # 2. ssh-agentì—ì„œ ëª¨ë“  í‚¤ ì œê±°
  ssh-add -D 2>/dev/null || true
  
  # 3. ì„ì‹œ í‚¤ íŒŒì¼ ì‚­ì œ
  rm -f /tmp/.ssh_key_* /tmp/.gpg_key_* 2>/dev/null || true
  
  # 4. GPG ê°œì¸í‚¤ ì‚­ì œ (keyringì—ì„œ ì œê±°)
  if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
    # --batch --yesë¡œ í™•ì¸ ì—†ì´ ì‚­ì œ
    gpg --batch --yes --delete-secret-keys "$GIT_SIGNING_KEY" 2>/dev/null || true
    echo "âœ… GPG ê°œì¸í‚¤ ì‚­ì œë¨"
  fi
  
  # 5. Git ì„œëª… ì„¤ì • í•´ì œ
  git config --global --unset user.signingkey 2>/dev/null || true
  git config --global --unset commit.gpgsign 2>/dev/null || true
  
  # 6. í™˜ê²½ë³€ìˆ˜ unset
  unset GITHUB_TOKEN GIT_SIGNING_KEY SSH_PRIVATE_KEY GPG_PRIVATE_KEY 2>/dev/null || true
  
  echo "âœ… ëª¨ë“  ì¸ì¦ ì •ë³´ ì‚­ì œë¨"
}

# ì‰˜ ì‹œì‘ì‹œ ìºì‹œ ìœ íš¨ì„± ì²´í¬
if [[ -f "$SECRETS_CACHE" ]]; then
  cache_age=$(( $(date +%s) - $(stat -f %m "$SECRETS_CACHE") ))
  if (( cache_age < SECRETS_TTL )); then
    source "$SECRETS_CACHE"
  else
    rm -f "$SECRETS_CACHE"
    echo "â° ì‹œí¬ë¦¿ ìºì‹œ ë§Œë£Œ (8ì‹œê°„ ê²½ê³¼) - auth-startë¡œ ì¬ì¸ì¦ í•„ìš”"
  fi
fi
