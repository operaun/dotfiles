# =============================================================================
# Zsh Configuration (managed by chezmoi)
# =============================================================================

# -----------------------------------------------------------------------------
# Homebrew (Apple Silicon / Intel Mac 호환)
# -----------------------------------------------------------------------------
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi


# -----------------------------------------------------------------------------
# SSH Agent 설정을 전역적으로 유지 (모든 쉘이 공유)
# -----------------------------------------------------------------------------
export SSH_AUTH_SOCK="$HOME/.ssh/ssh-agent.sock"

# 에이전트가 실행 중인지 확인 (연결 불가 시 2 반환)
ssh-add -l > /dev/null 2>&1
if [ $? -eq 2 ]; then
    # 기존 소켓 파일 정리
    rm -f "$SSH_AUTH_SOCK"
    # 새 에이전트 시작 (소켓 경로 고정)
    (umask 066; ssh-agent -a "$SSH_AUTH_SOCK" >/dev/null)
fi

# -----------------------------------------------------------------------------
# GPG 설정 (터미널에서 pinentry 사용)
# -----------------------------------------------------------------------------
export GPG_TTY=$(tty)
gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

# -----------------------------------------------------------------------------
# NVM 설정 (Lazy Loading - 쉘 시작 속도 개선)
# -----------------------------------------------------------------------------
# NVM Standard Loading (CLI 호환성 위해 Lazy Load 비활성화)
export NVM_DIR="$HOME/.nvm"

if [[ -f /opt/homebrew/opt/nvm/nvm.sh ]]; then
  source "/opt/homebrew/opt/nvm/nvm.sh"
  [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && source "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
elif [[ -f /usr/local/opt/nvm/nvm.sh ]]; then
  source "/usr/local/opt/nvm/nvm.sh"
fi

# -----------------------------------------------------------------------------
# PATH 설정
# -----------------------------------------------------------------------------
export PATH="$HOME/.opencode/bin:$PATH"
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# -----------------------------------------------------------------------------
# 모던 CLI 도구 초기화
# -----------------------------------------------------------------------------
# Starship 프롬프트
eval "$(starship init zsh)"

# Zoxide (스마트 cd)
eval "$(zoxide init zsh)"

# FZF
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# -----------------------------------------------------------------------------
# Aliases: 기존 도구 -> 모던 도구 대체
# -----------------------------------------------------------------------------
# ✅ 100% 하위호환 - alias로 완전 대체 가능
alias ls="eza"                    # ls -> eza
alias ll="eza -la"
alias la="eza -la"
alias lt="eza --tree"
alias cat="bat"                   # cat -> bat
alias find="fd"                   # find -> fd
alias grep="rg"                   # grep -> ripgrep
alias man="tldr"                  # man -> tldr (간단한 예시용)

# 기존 도구 접근 필요시
alias orig-ls="/bin/ls"
alias orig-cat="/bin/cat"
alias orig-find="/usr/bin/find"
alias orig-grep="/usr/bin/grep"
alias orig-man="/usr/bin/man"

# Git 관련
alias vim="nvim"
alias gs="git status -sb"
alias gp="git pull"
alias lg="lazygit"

# -----------------------------------------------------------------------------
# 대체 도구 사용 가이드 (100% 호환 아닌 경우)
# -----------------------------------------------------------------------------
# | AS-IS (기존)              | TO-BE (모던)                  | 비고                    |
# |---------------------------|-------------------------------|-------------------------|
# | curl -X GET url           | http GET url                  | httpie: 더 직관적 문법  |
# | curl -d '{"a":1}' url     | http POST url a=1             | JSON 자동 처리          |
# | man command               | tldr command                  | 전체 매뉴얼은 orig-man  |
# | cd /long/path && cd -     | z path (학습 후 자동 점프)    | zoxide: 히스토리 기반   |

{{- if .isPersonal }}
# -----------------------------------------------------------------------------
# 시크릿 및 키 관리 (auth-start / auth-stop) - Personal 전용
# -----------------------------------------------------------------------------
SECRETS_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/secrets.env"
SECRETS_TTL=28800  # 8시간 (초)

auth-start() {
  # Infisical CLI 설치 확인
  if ! command -v infisical &>/dev/null; then
    echo "❌ Infisical CLI가 설치되지 않았습니다."
    return 1
  fi

  echo "🔐 Infisical에서 인증 정보 로딩..."
  
  # 1. Infisical 로그인 확인
  if ! infisical whoami &>/dev/null; then
    infisical login
  fi
  
  # 2. 캐시 디렉토리 생성 (XDG 규격)
  mkdir -p "$(dirname "$SECRETS_CACHE")"
  
  # 3. 환경변수 시크릿 로드 (PRIVATE_KEY 제외)
  # JSON 포맷으로 export 후 jq를 사용하여 안전하게 파싱 및 이스케이프 (멀티라인 시크릿 지원)
  # jq가 없으면 설치 안내
  if ! command -v jq &>/dev/null; then
      echo "❌ jq가 설치되지 않았습니다. 'brew install jq'를 실행하세요."
      return 1
  fi

  infisical export --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --format=json | \
    jq -r '(if type=="array" then . else to_entries end) | map(select(.key | contains("PRIVATE_KEY") | not)) | map("export \(.key)=\(.value | @sh)") | .[]' > "$SECRETS_CACHE"
  
  chmod 600 "$SECRETS_CACHE"
  source "$SECRETS_CACHE"
  
  # 4. SSH 키 로드 (파이프 사용, 임시 파일 없음)
  if infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "🔑 SSH 키 로딩 중..."
    # ssh-add가 stdin(-)에서 키를 읽도록 함, -t 옵션으로 TTL 설정
    infisical secrets get SSH_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain | ssh-add -t $SECRETS_TTL - 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "✅ SSH 키가 ssh-agent에 로드됨 (8시간 유효)"
    else
        echo "⚠️  SSH 키 로드 실패"
    fi
  fi
  
  # 5. GPG 개인키 로드 (파이프 사용, 임시 파일 없음)
  if infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" &>/dev/null; then
    echo "🔏 GPG 키 로딩 중..."
    
    # GPG import (stdin 사용)
    infisical secrets get GPG_PRIVATE_KEY --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --plain | gpg --batch --import 2>/dev/null
    
    if [ $? -eq 0 ]; then
        # 6. GPG 서명키 설정 (동적 파일 사용)
        if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
            touch "$HOME/.gitconfig_env"
            git config -f "$HOME/.gitconfig_env" user.signingkey "$GIT_SIGNING_KEY"
            git config -f "$HOME/.gitconfig_env" commit.gpgsign true
            echo "✅ GPG 서명키 설정됨: $GIT_SIGNING_KEY"

            # 7. GPG 에이전트 설정 리로드 및 캐시 웜업
            gpg-connect-agent reloadagent /bye >/dev/null 2>&1
            
            echo "🔏 GPG 비밀번호 캐싱을 위해 서명을 시도합니다 (8시간 유지)..."
            echo "gpg-auth-start" | gpg --clearsign --local-user "$GIT_SIGNING_KEY" > /dev/null 2>&1
            
            if [ $? -eq 0 ]; then
                echo "✅ GPG 비밀번호가 캐시되었습니다."
            else
                echo "⚠️  GPG 서명 실패 (비밀번호 입력을 취소했거나 오류 발생)"
            fi
        fi
    else
      echo "⚠️  GPG 키 import 실패"
    fi
  fi
  
  echo "✅ 인증 완료 (8시간 유효)"
}

auth-stop() {
  echo "🔒 인증 정보 정리 중..."
  
  # 1. 시크릿 캐시 삭제
  if [[ -f "$SECRETS_CACHE" ]]; then
    rm -f "$SECRETS_CACHE"
  fi
  
  # 2. ssh-agent에서 모든 키 제거
  ssh-add -D 2>/dev/null || true
  
  # 3. GPG 개인키 삭제 (keyring에서 제거)
  if [[ -n "${GIT_SIGNING_KEY:-}" ]]; then
    gpg --batch --yes --delete-secret-keys "$GIT_SIGNING_KEY" 2>/dev/null || true
    echo "✅ GPG 개인키 삭제됨"
  fi
  
  # 4. Git 서명 설정 해제
  if [[ -f "$HOME/.gitconfig_env" ]]; then
    git config -f "$HOME/.gitconfig_env" --unset user.signingkey 2>/dev/null || true
    git config -f "$HOME/.gitconfig_env" --unset commit.gpgsign 2>/dev/null || true
  fi
  
  # 5. 환경변수 unset
  unset GITHUB_TOKEN GIT_SIGNING_KEY
  # PRIVATE_KEY 환경변수는 더 이상 로드되지 않지만 혹시 남아있을 경우를 대비해 unset
  unset SSH_PRIVATE_KEY GPG_PRIVATE_KEY
  
  echo "✅ 모든 인증 정보 삭제됨"
}

# 쉘 시작시 캐시 유효성 체크
if [[ -f "$SECRETS_CACHE" ]]; then
  cache_age=$(( $(date +%s) - $(stat -f %m "$SECRETS_CACHE") ))
  if (( cache_age < SECRETS_TTL )); then
    source "$SECRETS_CACHE"
  else
    rm -f "$SECRETS_CACHE"
    echo "⏰ 시크릿 캐시 만료 (8시간 경과) - auth-start로 재인증 필요"
  fi
fi
{{- end }}

