# =============================================================================
# Zsh Configuration (managed by chezmoi)
# =============================================================================

# -----------------------------------------------------------------------------
# Homebrew (Apple Silicon)
# -----------------------------------------------------------------------------
eval "$(/opt/homebrew/bin/brew shellenv)"

# -----------------------------------------------------------------------------
# NVM ì„¤ì •
# -----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"

# -----------------------------------------------------------------------------
# PATH ì„¤ì •
# -----------------------------------------------------------------------------
export PATH="$HOME/.opencode/bin:$PATH"
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# -----------------------------------------------------------------------------
# ëª¨ë˜ CLI ë„êµ¬ ì´ˆê¸°í™”
# -----------------------------------------------------------------------------
# Starship í”„ë¡¬í”„íŠ¸
eval "$(starship init zsh)"

# Zoxide (ìŠ¤ë§ˆíŠ¸ cd)
eval "$(zoxide init zsh)"

# FZF
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# -----------------------------------------------------------------------------
# Aliases: ê¸°ì¡´ ë„êµ¬ -> ëª¨ë˜ ë„êµ¬ ëŒ€ì²´
# -----------------------------------------------------------------------------
# âœ… 100% í•˜ìœ„í˜¸í™˜ - aliasë¡œ ì™„ì „ ëŒ€ì²´ ê°€ëŠ¥
alias ls="eza"                    # ls -> eza
alias ll="eza -la"
alias la="eza -la"
alias lt="eza --tree"
alias cat="bat"                   # cat -> bat
alias find="fd"                   # find -> fd
alias grep="rg"                   # grep -> ripgrep
alias man="tldr"                  # man -> tldr (ê°„ë‹¨í•œ ì˜ˆì‹œìš©)

# ê¸°ì¡´ ë„êµ¬ ì ‘ê·¼ í•„ìš”ì‹œ
alias orig-ls="/bin/ls"
alias orig-cat="/bin/cat"
alias orig-find="/usr/bin/find"
alias orig-grep="/usr/bin/grep"
alias orig-man="/usr/bin/man"

# Git ê´€ë ¨
alias vim="nvim"
alias gs="git status -sb"
alias gp="git pull"
alias lg="lazygit"

# -----------------------------------------------------------------------------
# ëŒ€ì²´ ë„êµ¬ ì‚¬ìš© ê°€ì´ë“œ (100% í˜¸í™˜ ì•„ë‹Œ ê²½ìš°)
# -----------------------------------------------------------------------------
# | AS-IS (ê¸°ì¡´)              | TO-BE (ëª¨ë˜)                  | ë¹„ê³                     |
# |---------------------------|-------------------------------|-------------------------|
# | curl -X GET url           | http GET url                  | httpie: ë” ì§ê´€ì  ë¬¸ë²•  |
# | curl -d '{"a":1}' url     | http POST url a=1             | JSON ìë™ ì²˜ë¦¬          |
# | man command               | tldr command                  | ì „ì²´ ë§¤ë‰´ì–¼ì€ orig-man  |
# | cd /long/path && cd -     | z path (í•™ìŠµ í›„ ìë™ ì í”„)    | zoxide: íˆìŠ¤í† ë¦¬ ê¸°ë°˜   |

# -----------------------------------------------------------------------------
# ì‹œí¬ë¦¿ ìºì‹œ ê´€ë¦¬ (auth-start / auth-stop)
# -----------------------------------------------------------------------------
SECRETS_CACHE="$HOME/.secrets.env"
SECRETS_TTL=28800  # 8ì‹œê°„ (ì´ˆ)

auth-start() {
  echo "ğŸ” Infisicalì—ì„œ ì‹œí¬ë¦¿ ë¡œë”©..."
  if ! infisical whoami &>/dev/null; then
    infisical login
  fi
  infisical export --projectId "{{ .infisicalProjectId }}" --env "{{ .infisicalEnv }}" --format=dotenv > "$SECRETS_CACHE"
  chmod 600 "$SECRETS_CACHE"
  source "$SECRETS_CACHE"
  echo "âœ… ì‹œí¬ë¦¿ ë¡œë“œ ì™„ë£Œ (8ì‹œê°„ ìœ íš¨)"
}

auth-stop() {
  if [[ -f "$SECRETS_CACHE" ]]; then
    rm -f "$SECRETS_CACHE"
    echo "ğŸ”’ ì‹œí¬ë¦¿ ìºì‹œ ì‚­ì œë¨"
  fi
  # í™˜ê²½ë³€ìˆ˜ unset (í•„ìš”ì‹œ ì¶”ê°€)
  unset GITHUB_TOKEN GIT_SIGNING_KEY 2>/dev/null || true
}

# ì‰˜ ì‹œì‘ì‹œ ìºì‹œ ìœ íš¨ì„± ì²´í¬
if [[ -f "$SECRETS_CACHE" ]]; then
  cache_age=$(( $(date +%s) - $(stat -f %m "$SECRETS_CACHE") ))
  if (( cache_age < SECRETS_TTL )); then
    source "$SECRETS_CACHE"
  else
    rm -f "$SECRETS_CACHE"
    echo "â° ì‹œí¬ë¦¿ ìºì‹œ ë§Œë£Œ (8ì‹œê°„ ê²½ê³¼)"
  fi
fi
